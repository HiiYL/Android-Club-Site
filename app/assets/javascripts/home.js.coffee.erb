# This will handle after google's signin and signout
window.googleSigninCallback = (authResult)->
  console.log googleSigninCallback: authResult

  if !user_logged_in and authResult['status']['signed_in']
    
    # Try AJAX backend
    $.ajax
      type: 'POST'
      url: '/users/auth/google_oauth2/callback'
      beforeSend: (xhr)->
        xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').last().attr('content'))
      dataType: 'json'
      data: authResult

    .done (json)->
      # Change the login bar
      $('.notLoggedIn').addClass('hidden')
      $('.loggedIn').removeClass('hidden')
      $('#displayName').text(json.user.display_name)
      window.user_logged_in = true

    .always (json)->
      console.log({ajaxresult: json})

  else if user_logged_in && authResult['error'] == "user_signed_out"

    $.ajax
      type: 'DELETE'
      url: '/logout'
    .success ->
      $('.notLoggedIn').removeClass('hidden')
      $('.loggedIn').addClass('hidden')
      window.user_logged_in = false
    
  else
    console.log signin_error: authResult['error']

  return # Yea no one returns if statement

jQuery ->
  # Hook up sign out button
  $('#gPlusSignoutButton').click (e)->
    e.preventDefault()
    gapi.auth.signOut()

window.googleLoaded = ->
  gapi.signin.render('gPlusSigninButton',
    'clientid': '<%= ENV['GOOGLE_CLIENT_ID'] %>'
    'cookiepolicy': 'single_host_origin'
    'requestvisibleactions': 'http://schema.org/AddAction'
    'scope': 'https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/userinfo.email'
    'callback': 'googleSigninCallback'
  )
